set -exu

# running dep requires files to be under $GOPATH/src
mkdir ${BUILD_DIR}/src
mv ${BUILD_DIR}/istio.io ${BUILD_DIR}/src/istio.io
GOPATH=${BUILD_DIR}

go get -u github.com/golang/dep/cmd/dep

export PATH=$PATH:$GOPATH/bin

pushd ${BUILD_DIR}/src/istio.io/istio
  # Since isio is a submodule, its .git file contains a relative path reference
  # into istio-release's .git directory. That directory is not available in the
  # BUILD_DIR. A .git file isn't necessary to run dep,
  # but it does confuse dep if it's there (and invalid).
  rm -rf .git
  # we don't want people accidentally committing things that seem to work
  # but only because they ran `dep ensure` locally
  rm -rf vendor Gopkg.lock
  dep ensure -v
popd

# clean up directory structure only needed for running dep
mkdir -p ${BUILD_DIR}/istio.io/istio
mv ${BUILD_DIR}/src/istio.io/istio/pilot ${BUILD_DIR}/istio.io/istio/
mv ${BUILD_DIR}/src/istio.io/istio/vendor ${BUILD_DIR}/istio.io/istio/
rm -rf ${BUILD_DIR}/src
